<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>neo</title>
    <link href="styles/comp.css?v=2" rel="stylesheet" />
    <link href="libs/iconfont/iconfont.css?v=2" rel="stylesheet" />
    <link href="styles/layout.css?v=2" rel="stylesheet" />

</head>

<body>
    <div id="app">
        <neo-header></neo-header>
        <div class="page-block-info">
            <neo-info-title :title="$t('block.name')"   v-bind:id="index"></neo-info-title>
            <neo-block-info :block=block></neo-block-info>
            <neo-tran-list 
                ref="tran" 
                v-bind:block="index" 
                v-on:loaded="loaded"
                v-bind:page="currentPage"
                v-bind:count="pageCount">
            </neo-tran-list> 
            <neo-paging 
                v-bind:tint="tintColor" 
                v-bind:page="currentPage" 
                v-bind:count="pageCount" 
                v-bind:total="totalCount" 
                v-on:change="changePaging">
            </neo-paging><br />
            <neo-tran-script v-bind:scripts="scripts"></neo-tran-script>
        </div>
        <neo-footer></neo-footer>
    </div>
    <script src="config.js"></script>
    <script src="libs/rem/rem.js?v=2" data-psd="750"></script>
    <script src="libs/vue/vue.min.js"></script>
    <script src="libs/moment/moment.min.js"></script>

    <script src="libs/vue-i18n/vue-i18n.min.js"></script>
    <script src="i18n/en.js"></script>
    <script src="i18n/zhCHS.js"></script>

    <script src="libs/echarts/echarts.min.js"></script>
    <script src="https://cdn.bootcss.com/axios/0.18.0/axios.min.js"></script>
    <script src="component/comp.js"></script>

    <script>
        const i18n = new VueI18n({
            locale: localStorage.locale || 'zhCHS', // 语言标识
            messages:{
                en,zhCHS
            }
        })

        var app = new Vue({
            el: '#app',
            i18n,
            computed: {
                index: function() {
                    return GetUrlParam('index');
                }
            },
            data: {
                tintColor: '#F9C400',
                currentPage: 1,
                pageCount: 15,
                totalCount: 0,
                scripts: undefined,
                block:undefined,
                trsns: [
                    []
                ]
            },
            methods: {
                init: function() {
                    // this.$refs.neochart.init();
                    // this.$refs.wallet.init();
                    this.$refs.tran.init()

                    var that = this;
                    axios({
                        url: `${host}/api/v1/${network}/public/graphql`,
                        method: 'post', 
                        data: {
                            query: 
                                '{'+
                                    'BlockQuery (index:'+this.index+') {'+
                                    ' count ' +
                                    ' rows {'+
                                        ' _id '+
                                        ' hash '+
                                        ' size '+
                                        ' version '+
                                        ' previousblockhash '+
                                        ' merkleroot '+
                                        ' time '+
                                        ' index '+
                                        ' nonce '+
                                        ' nextconsensus '+
                                        ' confirmations '+
                                        ' nextblockhash '+
                                        ' transactions '+
                                        ' script { '+
                                            ' invocation '+
                                            ' verification '+
                                        ' } '+
                                    '}'+
                                  '}'+
                                '}'
                        }
                    })
                    .then(function (resp) {
                        var count = resp.data.data.BlockQuery.count;
                        if(count > 0){
                            that.scripts = [];
                            var item = resp.data.data.BlockQuery.rows[0];
                            if(item.script.invocation){
                                that.scripts.push({
                                    title: that.$t('block.invocationScript'),
                                    desc: item.script.invocation
                                })
                            }
                            if(item.script.verification) {
                                that.scripts.push({
                                    title: that.$t('block.verificationScript'),
                                    desc: item.script.verification
                                })
                            }

                            // block detail info
                            that.block = [
                                {title: that.$t('block.index'), desc: item.index, url: 'blockinfo.html?index='+item.index},
                                {title: that.$t('block.transactions'), desc: item.transactions},
                                {title: that.$t('block.hash'), desc: item.hash},
                                {title: that.$t('block.time'), desc: moment(item.time*1000).format("YYYY-MM-DD | HH:mm:ss")},
                                {title: that.$t('block.version'), desc: item.version},
                                {title: that.$t('block.merkleroot'), desc: item.merkleroot},
                                {title: that.$t('block.size'), desc: item.size},
                            ]
                        }
                    })
                    .catch(function (error) {
                        console.log(error);
                    });
                },
                loaded: function(data) {
                    console.log('loaded: ', data)
                    this.totalCount = data.count;
                },
                changePaging: function(args) {
                    this.currentPage = args.currentPage;
                    this.pageCount = args.pageCount;
                    this.totalCount = args.totalCount;
                    this.$refs.tran.init()
                }
            }
        })

        app.init();
    </script>
</body>

</html>